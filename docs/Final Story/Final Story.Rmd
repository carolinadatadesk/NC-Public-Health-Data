---
title: "North Carolina Local Health Departments"
date: "12/15/2020"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
knit: (function(i, encoding) {apstyle::render(i, encoding)})
---
<!-- Timestamp: leave this in to automatically track when a file is rendered -->
*Rendered at `r format(Sys.time(), '%I:%M %p, %b. %d, %Y')`*

<!-- Contact info: leave author/reporter/editor contact info here -->
*Firstname Lastname (<email@domain.com>)*

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
  )

knitr::opts_knit$set(
  root.dir = rprojroot::find_rstudio_root_file()
  )
```

```{r initialize class.source = 'fold-show'}
# Load files, environment variables, libraries, etc. here
library(tidyverse)
library(apstyle)
library(DT)
library(gsheet)
```

## Overview

Overall description TK.

## Loading Data
This story was inspired by [reporting done by the Kaiser Health News service](https://github.com/khnews/2020-underfunded-under-threat-data/) and begins by using the data they collected and cleaned.

```{r class.source = 'fold-show'}
khn_state_public_health_agencies <- read_csv("https://raw.githubusercontent.com/khnews/2020-underfunded-under-threat-data/master/data/01-state-public-health-agencies.csv")
```

## State Level Spending

### Changes From 2010-2018
**Spending on public health at the state level in North Carolina dropped by more than 27%. This is spending per capita, adjusted for inflation, between 2010 and 2018.**


```{r}
khn_state_public_health_agencies %>%
  filter(state_code =="NC", year %in% c(2010, 2018)) %>%
  select(year, expenditures_infl_per_capita) %>%
  pivot_wider(names_from = "year", values_from = "expenditures_infl_per_capita", names_prefix="year") %>%
  mutate(pct_change = (year2018 - year2010) / year2010)
  
```

**Raw expenditures dropped about 6%.**
```{r}
khn_state_public_health_agencies %>%
  filter(state_code =="NC", year %in% c(2010, 2018)) %>%
  select(year, expenditures) %>%
  pivot_wider(names_from = "year", values_from = "expenditures", names_prefix="year") %>%
  mutate(pct_change = (year2018 - year2010) / year2010)
  
```

**But when you adjust those raw numbers for the states population increase during that time, the decline goes to 13%.**
```{r}
khn_state_public_health_agencies %>%
  filter(state_code =="NC", year %in% c(2010, 2018)) %>%
  select(year, expenditures_per_capita) %>%
  pivot_wider(names_from = "year", values_from = "expenditures_per_capita", names_prefix="year") %>%
  mutate(pct_change = (year2018 - year2010) / year2010)
  
```


### Compared to Other States
**The national decline in state-level public health spending of 16%.**

```{r}
khn_state_public_health_agencies %>%
  filter(year %in% c(2010, 2018)) %>%
  #KHN excluded Missouri, Michigan, Texas and Wyoming 
  filter(!(state_code %in% c("MO","MI","TX","WY"))) %>%
  group_by(year) %>%
  summarise(total_expenditures = sum(expenditures_infl), total_pop = sum(population)) %>%
  mutate(national_expenditures_infl_per_capita = total_expenditures / total_pop) %>%
  select(year, national_expenditures_infl_per_capita) %>%
  pivot_wider(names_from = "year", values_from = "national_expenditures_infl_per_capita", names_prefix="year") %>%
  mutate(pct_change = (year2018 - year2010) / year2010) 
```

**North Carolina's per-person spending on state-level public health declined at a higher rate than all but six states -- Texas, South Carolina, Nevada, Kentucky, Arkansas and Alabama.**

```{r}
khn_state_public_health_agencies %>%
  filter(year %in% c(2010, 2018)) %>%
  select(state_code, year, expenditures_infl_per_capita) %>%
  pivot_wider(names_from = "year", values_from = "expenditures_infl_per_capita", names_prefix="year") %>%
  mutate(pct_change = (year2018 - year2010) / year2010) %>%
  arrange(pct_change) %>%
  datatable()
  
```

**North Carolina state government spent about $72 per person on public health in 2018, which is less than all but 13 other states.**

```{r}
khn_state_public_health_agencies %>%
  filter(!(state_code %in% c("MO", "MI", "TX", "WY"))) %>%
    #KHN excluded Missouri, Michigan, Texas and Wyoming 
  filter(year == 2018) %>%
  select(state_code, expenditures_infl_per_capita) %>%
  arrange(expenditures_infl_per_capita)%>%
  datatable(options = list(pageLength = 15))
```

**Ten years ago, North Carolina spent just over $100 per person and ranked 12 places higher compared to other states.**

```{r}
khn_state_public_health_agencies %>%
  filter(!(state_code %in% c("MO", "MI", "TX", "WY"))) %>%
    #KHN excluded Missouri, Michigan, Texas and Wyoming 
  filter(year == 2010) %>%
  select(state_code, expenditures_infl_per_capita) %>%
  arrange(expenditures_infl_per_capita)%>%
  datatable(options = list(pageLength = 50))
```

## Local Health Department Spending in N.C.
UNC students requested expenditures from all 85 local health department in North Carolina. They entered the data in a spreadsheet that matches the format of the Kaiser Health News expenditure data.  

The definition of expenditures on public health differ from year to year and from county to county. For example, some counties include veterans services in their public health budget while others do not. For this reporting, we used whatever definition each county used either in its budget or financial statements posted online or in their response to our request for public health expenditures.

Local expenditures on public health here include not just funding that comes directly from county governments. It also includes funding that comes from federal and state sources that are administered by local health departments. Including all these sources is standard practice nationally.

If there was any question about which spending to include or exclude, we used the [Financial Statement Template for Districts of Health](https://files.nc.gov/nctreasurer/documents/files/SLGFD/LGC/LocalGovFiscalMngmt/AnnualAud/FinancialStatementResources/IllustrativeFinancialStatements/other-financial-statement-templates-districts-of-health.xls) provided by the N.C. state Treasurer at [https://www.nctreasurer.com/state-and-local-government-finance-division/local-government-commission/other-units-financial-statement-resources](https://www.nctreasurer.com/state-and-local-government-finance-division/local-government-commission/other-units-financial-statement-resources) to guide us.

```{r class.source = 'fold-show'}
CompiledLHDExpenditures <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1Zc10pam92Y1218F90eXn9ri7-a4GQI1vhzING33nNSI/edit#gid=0")
```


They received data from 51 local health departments representing 56 counties, and there was some variance in the years each health department was able to provide.

```{r}
CompiledLHDExpenditures %>%
  group_by(lhd_name, county_name) %>%
  summarize(years_provided = n()) %>% 
  arrange(lhd_name) %>%
  datatable()
```


Forty-six health departments representing 51 counties provided full data spanning from 2010-2018.

```{r}
CompiledLHDExpenditures %>% filter(year >=2010, year<=2018) %>%
  pivot_wider(id_cols = lhd_name, names_from = year, values_from = expenditures, names_prefix = "year") %>% 
  filter(!is.na(year2010),
         !is.na(year2011),
         !is.na(year2012),
         !is.na(year2013),
         !is.na(year2014),
         !is.na(year2015),
         !is.na(year2016),
         !is.na(year2017),
         !is.na(year2018)) %>%
  arrange(lhd_name) %>%
  datatable()

```


Population data for each county comes from the website of the State Demographer.

```{r class.source = 'fold-show'}
county_pop <- read_delim("https://demography.osbm.nc.gov/explore/dataset/population-voting-age-density-migration/download/?format=csv&disjunctive.area_name=true&disjunctive.area_type=true&disjunctive.year=true&disjunctive.data_type=true&disjunctive.vintage=true&refine.variable=Population+(Census%2FEstimate%2FProjection)&refine.year=2018&refine.year=2017&refine.year=2015&refine.year=2012&refine.year=2011&refine.year=2010&refine.year=2013&refine.year=2014&refine.year=2016&refine.area_type=County&timezone=America/New_York&lang=en&use_labels_for_header=true&csv_separator=%3B", 
    ";", escape_double = FALSE, col_types = cols_only(`Area Name` = col_character(), 
        Year = col_double(), Value = col_double()), 
    trim_ws = TRUE) %>%
  rename(county_name = `Area Name`, year = `Year`)


county_pop$county_name <-  str_sub(county_pop$county_name, end = -8)
  
```

```{r}
new<- left_join(CompiledLHDExpenditures, county_pop, c("county_name" = "county_name", "year" = "year")) %>%
  
  
  new %>%
  select(county_name, year, population, Value) %>%
  filter(!is.na(Value)) %>%
  mutate(pct_diff=100*(Value-population)/population) %>%
  filter(pct_diff != 0) %>%
  arrange(desc(pct_diff)) 
```

These health departments serve about 66% of North Carolina’s population.

```{r class.source = 'fold-show'}

```

From 2009-2017, 62 of the 85 local health departments’ full-time staff decreased. 


```{r}

NEED TO PULL KHN DATA ON COUNTY FTES HERE


khn_state_public_health_agencies %>%
  filter(year %in% c('2009', '2017')) %>%
  pivot_wider(id_cols = -c(fte_per_100000,population), names_from = year, values_from = fte) %>%
  # DONT NEED NEXT LINE - RT
 # group_by(lhd_name) %>%
  mutate(pct_change = 100 * ((`2017` - `2003`)) / `2003`) %>%
  arrange(desc(pct_change))
```

```


The average decrease in staff across the departments was close to 11%. 
```{r}

```


Thirteen health departments saw their staffing drop by more than a third over the time period. 
```{r}

```


## References

<!-- This section is for including references to related material -->

- Infaltion Adjustment

- KHN GitHub Repository

<!-- This section is for a tests code block -->

```{r tests}
# Leave this block of code at the end of the file
# If a test fails it will stop the Rmd document from knitting
# Run tests like so:
# source("tests/etl_test.R")
```
